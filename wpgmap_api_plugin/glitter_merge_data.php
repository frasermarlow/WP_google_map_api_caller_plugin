<?php/* * function to take a base json file for a WP Google Map import (which is imported here as an array), and merge in a second $that came from our API call. * In this example the focus is to import 'marker' data (referred to here as 'pins') * */class Marker {    // this class's properties match the fields required by WP Google Map markers ( WP Google Maps Version 8.1.22 ).    public ?string $id;    public ?string $map_id;    public ?string $address;    public ?string $description = "";    public ?string $pic = "";    public ?string $link;    public ?string $lat;    public ?string $lng;    public ?string $icon = "";    public ?string $anim = "2";    public ?string $title = "";    public ?string $infoopen = "0";    public ?string $category;    public ?string $approved = "1";    public ?string $retina = "0";    public ?string $type = "0";    public ?string $did = "";    public ?string $sticky = "0";    public ?string $other_data = "";    }function glitter_merge_data($base_array, $api_call_data) {    $base_array['markers'] = array(); // clear any existing markers in the base template        $cats = array();    foreach($base_array['categories'] as $c){        $cats[$c['category_name']]=$c['id'];    }        add_option('map_block_count'); # note, this will only have effect the very first time you install the plugin.    $block_count = 0;        $pin_array = array();  // Will be an $of objects, each object a pin.    $id = 0;        $test_array = array();  // useful for testing        $api_endpoint_string_length = strlen(get_option('glitter_map_api_endpoint'). get_option('glitter_map_api_resource'));        if (isset($api_call_data['accounts'])){                foreach($api_call_data['accounts'] as $account){            // For each account we will call the API and retrieve custom fields            $pin = new Marker();            $customFields = new GlitterMapObject();            $custom_field_endpoint = get_option('glitter_map_api_resource') . substr($account->links->accountCustomFieldData,$api_endpoint_string_length);            $customFieldList = $customFields->call_api($custom_field_endpoint)['customerAccountCustomFieldData'];                foreach($customFieldList as $customField){                $pin->map_id = $base_array['maps'][0]['id'];                if(isset($customField->custom_field_id) & $customField->custom_field_id=="18"){                        $pin->title = $customField->custom_field_text_value;                        $pin->other_data .= $customField->customer_account_id;                }                if(isset($customField->custom_field_id) & $customField->custom_field_id=="23"){                        $pin->link = $customField->custom_field_text_value;                }                if(isset($customField->custom_field_id) & $customField->custom_field_id=="32"){                        $pin->category = $cats[$customField->custom_field_text_value];                        $pin->description = "Frequency: " . $customField->custom_field_text_value . ".<br/>&nbsp;";                }                                                // Leaving out this next block for now as it duplicates the 'title'                /* if(isset($customField->custom_field_id) & $customField->custom_field_id=="18"){                        $pin->address = $customField->custom_field_text_value;                } */            }                        foreach($customFieldList as $customField){                                // In our case the account may have multiple markers. The data is stored in a custom multi-line text box.  So here we parse out each line, then parse out the lat and lng.                                    if(isset($customField->custom_field_id) & $customField->custom_field_id=="33"){                    $geocodes = explode("\n", $customField->custom_field_text_blob);                                        foreach($geocodes as $code){                        $pin->lat = str_replace(",", "", explode(" ",$code)[0]);                        $pin->lng = str_replace(",", "", explode(" ",$code)[1]);                        $pin->id = $id++;                        $pin->other_data .= $id;                                                if(!isset($pin->category)){                            $pin->category = $cats['unfunded'];                            $pin->description = "This block is not yet fully funded.<br/>&nbsp;";                            }                                                $temp_pin = clone $pin;                        array_push($pin_array,$temp_pin);                    }                }            }                    }            }    else {    echo "<-- no accounts found -->";    }    foreach($pin_array as $pin) {    $a = (array) $pin;    array_push($base_array['markers'],$a);    }    update_option('map_block_count', count($pin_array));    return array_merge($test_array, $base_array);}/* Add shortcode for intro text before the map */function render_glitter_map_intro_text(){	$output = "<h4>Glitter currently maintains <strong>" . get_option('map_block_count') . "</strong> blocks and commercial corridors on a regular basis:<br/>";    $output .= "<img class='alignnone size-full wp-image-1899' src='http://staging-getglitterapp.kinsta.cloud/wp-content/uploads/2022/04/glitter_pin_1.png' alt='' width='33' />: Serviced blocks&nbsp;|&nbsp;";	$output .= "<img class='wpgmza-category-marker-icon' data-marker-icon-src='{&quot;url&quot;:&quot;\/\/staging-getglitterapp.kinsta.cloud\/wp-content\/uploads\/2022\/05\/glitter_unfunded_pin.png&quot;,&quot;retina&quot;:0}' src='//staging-getglitterapp.kinsta.cloud/wp-content/uploads/2022/05/glitter_unfunded_pin.png' width='33'>: Needs funding<br/>\n";	$output .= "Click on a marker to help sponsor an existing block or click 'Contribute' to launch funding of a new block.</h4>";	echo $output;}function register_glitter_shortcodes(){	 add_shortcode('glitter-map-intro-text', 'render_glitter_map_intro_text');}add_action( 'init', 'register_glitter_shortcodes');?>